{#
802.1X Authentication Configuration Template
This template configures IEEE 802.1X authentication with ISE integration
Supports dynamic VLAN assignment and MAB fallback
#}

{# Enable AAA and 802.1X features #}
aaa new-model
aaa authentication dot1x default group radius
aaa authorization network default group radius
aaa accounting dot1x default start-stop group radius
aaa accounting network default start-stop group radius

{# RADIUS Server Configuration #}
radius server ISE-PRIMARY
  address ipv4 {{ global_settings.ise_integration.primary_server_address }} auth-port {{ global_settings.ise_integration.authentication_port }} acct-port {{ global_settings.ise_integration.accounting_port }}
  key {{ global_settings.ise_integration.shared_secret }}
  timeout {{ global_settings.ise_integration.timeout }}
  retransmit {{ global_settings.ise_integration.retries }}

{# AAA Server Group #}
aaa group server radius ISE-GROUP
  server name ISE-PRIMARY
  ip radius source-interface Vlan1

{# 802.1X Global Configuration #}
dot1x system-auth-control
dot1x critical eapol

{# Device Tracking Policy #}
device-tracking policy DT_POLICY
  no protocol udp
  tracking enable

{# Access Control Lists for Guest Traffic #}
ip access-list extended GUEST_ACL
  permit ip any host 8.8.8.8
  permit ip any host 8.8.4.4
  permit udp any eq bootpc any eq bootps
  permit udp any any eq domain
  permit tcp any any eq www
  permit tcp any any eq 443
  deny ip any any

{# Interface Template for Access Ports with 802.1X #}
interface GigabitEthernet1/0/1-24
  description "802.1X Access Port"
  switchport mode access
  switchport access vlan {{ site.vlans[0].vlan_id }}
  switchport voice vlan {{ site.vlans[1].vlan_id if site.vlans|length > 1 else site.vlans[0].vlan_id }}
  
  {# 802.1X Configuration #}
  authentication event fail action next-method
  authentication event server dead action authorize vlan {{ site.vlans[0].vlan_id }}
  authentication event server dead action authorize voice
  authentication event server alive action reinitialize
  authentication host-mode multi-auth
  authentication open
  authentication order dot1x mab
  authentication priority dot1x mab
  authentication port-control auto
  authentication periodic
  authentication timer reauthenticate server
  authentication timer inactivity server
  authentication violation restrict
  
  {# MAB Configuration #}
  mab
  
  {# Device Tracking #}
  device-tracking attach-policy DT_POLICY
  
  {# Port Security (if needed) #}
  switchport port-security maximum 10
  switchport port-security violation restrict
  switchport port-security aging time 2
  switchport port-security aging type inactivity
  
  {# Spanning Tree #}
  spanning-tree portfast
  spanning-tree bpduguard enable

{# Interface Template for Trunk Ports (AP connectivity) #}
interface GigabitEthernet1/0/25-28
  description "AP Trunk Port with 802.1X"
  switchport mode trunk
  switchport trunk allowed vlan {{ site.vlans | map(attribute='vlan_id') | join(',') }}
  
  {# 802.1X for AP #}
  authentication host-mode multi-domain
  authentication port-control auto
  authentication order dot1x
  authentication priority dot1x
  
  {# Device Tracking #}
  device-tracking attach-policy DT_POLICY
  
  {# Spanning Tree #}
  spanning-tree portfast trunk
  spanning-tree bpduguard enable

{# VLAN Definitions for Dynamic Assignment #}
{% for vlan in site.vlans %}
vlan {{ vlan.vlan_id }}
  name {{ vlan.vlan_name }}
{% endfor %}

{# DHCP Snooping Configuration #}
ip dhcp snooping
ip dhcp snooping information option
{% for vlan in site.vlans %}
ip dhcp snooping vlan {{ vlan.vlan_id }}
{% endfor %}

{# Dynamic ARP Inspection #}
ip arp inspection validate src-mac dst-mac ip
{% for vlan in site.vlans %}
ip arp inspection vlan {{ vlan.vlan_id }}
{% endfor %}

{# IP Source Guard (if needed) #}
{% for vlan in site.vlans %}
vlan configuration {{ vlan.vlan_id }}
  ip verify source dhcp-snooping port-security
{% endfor %}

{# CoA (Change of Authorization) Configuration #}
aaa server radius dynamic-author
  client {{ global_settings.ise_integration.primary_server_address }} server-key {{ global_settings.ise_integration.shared_secret }}
  port 3799
  auth-type any

{# Critical Authentication VLAN (when ISE is down) #}
vlan 999
  name CRITICAL_AUTH_VLAN

{# Guest VLAN Configuration #}
{% if site.vlans | selectattr('vlan_name', 'match', 'GUEST.*') | list | length > 0 %}
{% set guest_vlan = site.vlans | selectattr('vlan_name', 'match', 'GUEST.*') | first %}
vlan {{ guest_vlan.vlan_id }}
  name {{ guest_vlan.vlan_name }}

interface Vlan{{ guest_vlan.vlan_id }}
  ip access-group GUEST_ACL in
{% endif %}

{# Logging for 802.1X events #}
logging buffered 8192 informational
logging host {{ site.network_settings.syslog_server[0].server_ip }}

{# SNMP Configuration for monitoring #}
snmp-server community {{ global_settings.credentials.snmp_v2_read_credentials[0].community }} RO
snmp-server host {{ site.network_settings.snmp_server[0].server_ip }} version 2c {{ global_settings.credentials.snmp_v2_read_credentials[0].community }}

{# End of 802.1X Template #}
