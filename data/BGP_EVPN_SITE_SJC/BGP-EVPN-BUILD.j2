{# ============================================================================== #}
{#                                                                                #}
{#  Cisco Catalyst Center BGP EVPN VXLAN Campus Fabric Templates                 #}
{#                                                                                #}
{#  Master Build Template - Orchestrates all DEFN and FABRIC templates           #}
{#                                                                                #}
{#  This template collection provisions Campus BGP EVPN VXLAN fabrics on         #}
{#  Cisco Catalyst 9000 series switches running IOS-XE. It generates role-aware  #}
{#  configurations for spine-leaf topologies with multi-tenancy support,         #}
{#  Tenant Routable Multicast (TRM), and optional IPSEC transport for            #}
{#  cross-fabric segment extension.                                              #}
{#                                                                                #}
{#  Authors:                                                                      #}
{#    Igor Manassypov, Systems Engineer, imanassy@cisco.com                       #}
{#    Keith Baldwin, Technical Solutions Architect, kebaldwi@cisco.com            #}
{#                                                                                #}
{#  Copyright (c) 2024-2026 Cisco Systems, Inc. All rights reserved.             #}
{#                                                                                #}
{# ============================================================================== #}

{% include "BGP_EVPN_SITE_SJC/DEFN-VRF.j2" %}
{% include "BGP_EVPN_SITE_SJC/DEFN-ROLES.j2" %}
{% include "BGP_EVPN_SITE_SJC/DEFN-LOOPBACKS.j2" %}
{% include "BGP_EVPN_SITE_SJC/DEFN-OVERLAY.j2" %}
{% include "BGP_EVPN_SITE_SJC/DEFN-IPSEC.j2" %}
{% include "BGP_EVPN_SITE_SJC/DEFN-VNIOFFSETS.j2" %}
{% include "BGP_EVPN_SITE_SJC/DEFN-L3OUT.j2" %}
{% include "BGP_EVPN_SITE_SJC/DEFN-MCAST.j2" %}
{% include "BGP_EVPN_SITE_SJC/DEFN-NAC-IOT.j2" %}
{% include "BGP_EVPN_SITE_SJC/FUNC-OBJECT-MACROS.j2" %}
{% include "BGP_EVPN_SITE_SJC/FABRIC-VRF.j2" %}
{% include "BGP_EVPN_SITE_SJC/FABRIC-LOOPBACKS.j2" %}
{% include "BGP_EVPN_SITE_SJC/FABRIC-IPSEC.j2" %}
{% include "BGP_EVPN_SITE_SJC/FABRIC-NVE.j2" %}
{% include "BGP_EVPN_SITE_SJC/FABRIC-MCAST.j2" %}
{% include "BGP_EVPN_SITE_SJC/FABRIC-EVPN.j2" %}
{% include "BGP_EVPN_SITE_SJC/FABRIC-OVERLAY.j2" %}
{% include "BGP_EVPN_SITE_SJC/FABRIC-NAC-IOT.j2" %}

{# DEREFERENCE THE DEVICE HOSTNAME ONCE AND PASS TO EACH BUILD FUNCTION #}
{% set DEVICE_HOSTNAME = __device.hostname | default('', true) %}

{# BUILD LAYERS OF CONFIG #}
{# Step 1. VRF #}
{{ vrfDefinitionBuild(DEF_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_LOOP_UNDERLAY, FABRIC_BGP_ASN) }}

{# Step 2. UNDERLAY AND SERVICE LOOPBACKS #}
{{ interfaceLoopbackBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_LOOP_NAME, DEFN_LOOP_UNDERLAY, DEFN_NODE_ROLES, DEFN_LOOP_IPSEC, FABRIC_UNDERLAY, DEFN_LOOP_MCLUSTER) }}

{# Step 3. UNDERLAY IPSEC OR GRE TRANSPORT TUNNELS ONLY ON BORDERS #}
{{ interfaceTunnelBuild(DEFN_NODE_ROLES, FABRIC_IPSEC_UNDERLAY, DEFN_LOOP_IPSEC, DEFN_LOOP_NAME) }}

{# Step 4. VLANS, L2VNI AND L3VNI MAPPINGS #}
{{ nveVlanBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, L3VNIOFFSET, DEFN_LOOP_NAME) }}

{# Step 5. MULTICAST - TRM #}
{{ multicastRoutingBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_NODE_ROLES, DEFN_LOOP_NAME, DEFN_LOOP_UNDERLAY, FABRIC_RP_ADDR, FABRIC_UNDERLAY, FABRIC_BGP_ASN, FABRIC_RP_SCOPES, ENTERPRISE_RP_SCOPES, ENTERPRISE_RP_ADDR, DEFN_L3OUT ) }}

{# Step 6. BGP EVPN PEERINGS #}
{{ evpnBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_NODE_ROLES, DEFN_LOOP_UNDERLAY, DEFN_L3OUT, FABRIC_BGP_ASN, DEFN_LOOP_NAME, DEFN_IPSEC, DEFN_LOOP_MCLUSTER, DEFN_L3OUT_AGGREGATES ) }}

{# Step 7. BGP OVERLAYS #}
{{ overlayBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, FABRIC_BGP_ASN, DEFN_OVERLAY, DEFN_NODE_ROLES, L2VNIOFFSET) }}

{# Step 8. SECURE ACCESS PORTS #}
{{ ibnsBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_NAC_IOT) }}

{# End of Build #}
