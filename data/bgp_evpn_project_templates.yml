# Select Catalyst Center version, this one overwrite the default version from host file
catalyst_center_version: 2.3.7.9

# BGP EVPN Project Templates Configuration
# Based on templates from catalyst-center-bgp-evpn-examples submodule
# 
# This file contains all the BGP EVPN VXLAN Campus Fabric templates:
# 
# Definition Templates (DEFN-*):
#   - DEFN-MCAST: Multicast definitions for EVPN fabric
#   - DEFN-VRF: VRF definitions for multi-tenancy (red, blue, green)
#   - DEFN-ROLES: Device role definitions (spine/leaf/border nodes)
#   - DEFN-LOOPBACKS: Loopback interface definitions for underlay/overlay
#   - DEFN-VNIOFFSETS: VNI offset definitions for L2 and L3 VNIs
#
# Fabric Templates (FABRIC-*):
#   - 1. FABRIC-VRF: VRF configuration for multi-tenancy
#   - 2. FABRIC-LOOPBACKS: Loopback interface configuration
#   - 3. FABRIC-NVE: Network Virtualization Edge (NVE) interface configuration
#
# Composite Templates:
#   - 0. BGP-EVPN: Complete BGP EVPN fabric configuration (combines all FABRIC templates)
#
# Usage: Deploy these templates to Catalyst Center using the device_templates role
# or the template management workflows from catalyst-center-iac submodule
template_details:
  # BGP EVPN Project Templates
  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Multicast definitions for EVPN fabric"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-MCAST
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% set FABRIC_RP_ADDR  = '172.16.255.254' %}
        {% set FABRIC_RP_SCOPES = ['239.190.0.0 0.0.255.255'] %}
        
        {% set ENTERPRISE_RP_ADDR  = '172.17.254.100' %}
        {% set ENTERPRISE_RP_SCOPES = ['238.190.0.0 0.0.255.255'] %}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "VRF definitions for multi-tenancy"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-VRF
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {# NAMING CONVENTION#}
        {#MDT DEFAULT: 239.190.1XX.1#}
        {#MDT DATA:    239.190. XX.1#}
        {% set DEFN_VRF = [
          {'id':'901','name':'red', 'mdt_default':'239.190.0.1', 'mdt_data':'239.190.1.0'},
          {'id':'902','name':'blue', 'mdt_default':'239.190.0.2', 'mdt_data':'239.190.2.0'},
          {'id':'903','name':'green', 'mdt_default':'239.190.0.3', 'mdt_data':'239.190.3.0'}
          ]
        %}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Device role definitions for spine/leaf/border nodes"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-ROLES
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% set DEFN_NODE_ROLES = {
          'SPINE': ['kinstone-spine1.dcloud.cisco.com', 'halifax-spine2.dcloud.cisco.com'],
          'RR': ['kinstone-spine1.dcloud.cisco.com', 'halifax-spine2.dcloud.cisco.com'],
          'CLIENT': ['apex-leaf1.dcloud.cisco.com', 'cary-leaf2.dcloud.cisco.com', 'lagrange-leaf3.dcloud.cisco.com', 'carolinas37-border1.dcloud.cisco.com', 'carolinas50-border2.dcloud.cisco.com'],
          'BORDER': ['carolinas37-border1.dcloud.cisco.com', 'carolinas50-border2.dcloud.cisco.com']
        } %}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Loopback interface definitions"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-LOOPBACKS
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% set DEFN_LOOP_UNDERLAY = {
          'kinstone-spine1.dcloud.cisco.com': '172.16.255.1',
          'halifax-spine2.dcloud.cisco.com': '172.16.255.2',
          'apex-leaf1.dcloud.cisco.com': '172.16.255.3',
          'cary-leaf2.dcloud.cisco.com': '172.16.255.4',
          'lagrange-leaf3.dcloud.cisco.com': '172.16.255.5',
          'carolinas37-border1.dcloud.cisco.com': '172.16.255.6',
          'carolinas50-border2.dcloud.cisco.com': '172.16.255.7'
        } %}
        
        {% set DEFN_LOOP_OVERLAY = {
          'red': '10.1.91.',
          'blue': '10.1.92.',
          'green': '10.1.93.'
        } %}
        
        {% set DEFN_LOOP_NAME = {
          'UNDERLAY': 'Loopback0',
          'ANYCAST': 'Loopback2'
        } %}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "VRF configuration for multi-tenancy"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "1. FABRIC-VRF"
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% include "EVPN/DEFN-VRF" %}
        {% include "EVPN/DEFN-ROLES" %}
        {% include "EVPN/DEFN-LOOPBACKS" %}
        
        {# Resolve the VRF objects upfront #}
        {% set vrf_objs = [] %}
        {% for input_vrf in vrf_list %}
          {% set _vrf = (DEFN_VRF | selectattr("name", "equalto", input_vrf) | list | first) %}
          {% if _vrf %}{% do vrf_objs.append(_vrf | first) %}{% endif %}
        {% endfor %}
        
        {% for vrf in vrf_objs %}
        vrf definition {{ vrf.name }}
        description VRF {{ vrf.name }} definition
        rd {{ DEFN_LOOP_UNDERLAY[__device.hostname] }}:{{ vrf.id }}
        !
        address-family ipv4
        route-target export {{ FABRIC_BGP_ASN }}:{{ vrf.id }}
        route-target import {{ FABRIC_BGP_ASN }}:{{ vrf.id }}
        route-target export {{ FABRIC_BGP_ASN }}:{{ vrf.id }} stitching
        route-target import {{ FABRIC_BGP_ASN }}:{{ vrf.id }} stitching
        exit-address-family
        !
        {% endfor %}
        {% endraw %}
      template_params:
        - parameter_name: vrf_list
          data_type: STRING
          default_value: null
          description: "List of VRF names to configure"
          required: false
          param_array: true
          selection:
            selection_type: MULTI_SELECT
            selection_values:
              "901": "red"
              "902": "green"
              "903": "blue"
        - parameter_name: FABRIC_BGP_ASN
          data_type: INTEGER
          default_value: 65001
          description: "BGP AS number for the fabric"
          required: true
          param_array: false
        - parameter_name: __device
          data_type: STRING
          default_value: null
          description: "Device object"
          required: true
          param_array: false
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "Loopback interface configuration for underlay and overlay"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "2. FABRIC-LOOPBACKS"
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% if vlan_id is not defined %}
        {% set blah = "EVPN" + "/DEFN-VRF" %}
        {% endif %}
        
        {% include "EVPN/DEFN-ROLES" %}
        {% include "EVPN/DEFN-LOOPBACKS" %}
        
        {# UNDERLAY LOOPBACKS #}
        interface {{DEFN_LOOP_NAME['UNDERLAY']}}
        description UNDERLAY-NVE-INTERFACE
        ip address {{DEFN_LOOP_UNDERLAY[__device.hostname]}} 255.255.255.255
        ip pim sparse-mode
        !
        {% if __device.hostname in DEFN_NODE_ROLES['SPINE'] or __device.hostname in DEFN_NODE_ROLES['BORDER'] %}
        {# SKIP #}
        {% else %}
            {% for input_vrf in vrf_list %}
            {% for vrf in DEFN_VRF %}
            {% if vrf.name == input_vrf %}
                {% set ip = DEFN_LOOP_UNDERLAY[__device.hostname] %}
                {% set split_ip = ip.split('\\.') %}
                {% set last_octet = split_ip[3] %}
                interface Loopback{{vrf.id}}
                description OVERLAY-VRF-{{vrf.name}}
                vrf forwarding {{vrf.name}}
                ip address {{DEFN_LOOP_OVERLAY[vrf.name]}}{{last_octet}} 255.255.255.255
                ip pim sparse-mode
                !
            {% endif %}
            {% endfor %}
            {% endfor %}
        {% endif %}
        {% endraw %}
      template_params:
        - parameter_name: vrf_list
          data_type: STRING
          default_value: null
          description: "List of VRF names to configure"
          required: false
          param_array: true
          selection:
            selection_type: MULTI_SELECT
            selection_values:
              "901": "red"
              "902": "green"
              "903": "blue"
        - parameter_name: vlan_id
          data_type: STRING
          default_value: null
          description: "VLAN ID"
          required: true
          param_array: false
        - parameter_name: __device
          data_type: STRING
          default_value: null
          description: "Device object"
          required: true
          param_array: false
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "VNI offset definitions for L2 and L3 VNIs"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-VNIOFFSETS
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {# NAMING CONVENTIONS   #}
        {# L3VNI {{L3VNIOFFSET}}{{ VRF ID }} #}
        {# L3VNI 50XXX #}
        {# L2VNI {{L2VNIOFFSET}}+{{ VLAN ID }} #}
        {# L2VNI 10XXX #}
        
        {% set L2VNIOFFSET = 10000 %}
        {% set L3VNIOFFSET = 50 %}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Overlay network definitions for EVPN fabric"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-OVERLAY
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% set FABRIC_BGP_ASN = '65001' %}
        {% set FABRIC_UNDERLAY = {'proto':'ospf', 'instance_id':'1', 'area':'0'} %}
        
        {% set DEFN_OVERLAY = [
          {
            'vrf': 'red',
            'vlans': {
              '101': {'name':'corp-11', 'ipaddr': '10.1.11.1 255.255.255.0', 'mac':'0000.0901.0101', 'dhcp_helper':'198.18.5.253', 'bum_addr':'239.190.100.11'},
              '102': {'name':'corp-12', 'ipaddr': '10.1.12.1 255.255.255.0', 'mac':'0000.0901.0102', 'dhcp_helper':'198.18.5.253', 'bum_addr':'239.190.100.12'},
              '103': {'name':'corp-13', 'ipaddr': '10.1.13.1 255.255.255.0', 'mac':'0000.0901.0103', 'dhcp_helper':'198.18.5.253', 'bum_addr':'239.190.100.13'}
            }
          },
          {
            'vrf': 'blue',
            'vlans': {
              '201': {'name':'guest-21', 'ipaddr': '10.1.21.1 255.255.255.0', 'mac':'0000.0902.0201', 'dhcp_helper':'198.18.5.253', 'bum_addr':'239.190.100.21'},
              '202': {'name':'guest-22', 'ipaddr': '10.1.22.1 255.255.255.0', 'mac':'0000.0902.0202', 'dhcp_helper':'198.18.5.253', 'bum_addr':'239.190.100.22'}
            }
          },
          {
            'vrf': 'green',
            'vlans': {
              '301': {'name':'iot-31', 'ipaddr': '10.1.31.1 255.255.255.0', 'mac':'0000.0903.0301', 'dhcp_helper':'198.18.5.253', 'bum_addr':'239.190.100.31'},
              '302': {'name':'iot-32', 'ipaddr': '10.1.32.1 255.255.255.0', 'mac':'0000.0903.0302', 'dhcp_helper':'198.18.5.253', 'bum_addr':'239.190.100.32'}
            }
          }
        ] %}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Layer 3 external connectivity definitions"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-L3OUT
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% set DEFN_L3OUT = [
          {
            'vrf': 'red',
            'node': 'kinstone-spine1.dcloud.cisco.com',
            'neighbour_asn': '65002',
            'interfaces': {
              'TenGigabitEthernet1/0/7.2': {'name': 'uplink1', 'vlan': '2', 'ipaddr': '10.255.255.1 255.255.255.252', 'neighbour': '10.255.255.2'},
              'TenGigabitEthernet1/0/8.2': {'name': 'uplink2', 'vlan': '2', 'ipaddr': '10.255.255.5 255.255.255.252', 'neighbour': '10.255.255.6'}
            }
          }
        ] %}
        
        {% set DEFN_L3OUT_AGGREGATES = [
          "10.1.11.0 255.255.255.0",
          "10.1.12.0 255.255.255.0",
          "10.1.13.0 255.255.255.0",
          "10.1.21.0 255.255.255.0",
          "10.1.22.0 255.255.255.0",
          "10.1.31.0 255.255.255.0",
          "10.1.32.0 255.255.255.0"
        ] %}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "NAC IoT definitions for network access control"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-NAC-IOT
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% set DEFN_NAC_IOT = [
          {'vrf':'blue', 'nac_ip':'198.18.7.254', 'nac_key':'C!sco123'}
        ] %}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "Network Virtualization Edge (NVE) interface configuration"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "3. FABRIC-NVE"
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% include "EVPN/DEFN-VRF" %}
        {% include "EVPN/DEFN-ROLES" %}
        {% include "EVPN/DEFN-LOOPBACKS" %}
        {% include "EVPN/DEFN-VNIOFFSETS" %}
        
        {# Resolve the VRF objects upfront #}
        {% set vrf_objs = [] %}
        {% for input_vrf in vrf_list %}
          {% set _vrf = (DEFN_VRF | selectattr("name", "equalto", input_vrf) | list | first) %}
          {% if _vrf %}{% do vrf_objs.append(_vrf | first) %}{% endif %}
        {% endfor %}
        
        {# --- VLAN SECTION --- #}
        ! @start-ignore-compliance 
        {% for vrf in vrf_objs %}
        vlan {{ vrf.id }}
         name L3-VRF-CORE-{{ vrf.id }}
        !
        {% endfor %}
        ! @end-ignore-compliance
        
        {# --- VLAN CONFIGURATION SECTION --- #}
        {% for vrf in vrf_objs %}
        vlan configuration {{ vrf.id }}
         member vni {{ (L3VNIOFFSET|string) + vrf.id }}
        !
        {% endfor %}
        
        {# --- INTERFACE VLAN SECTION --- #}
        {% for vrf in vrf_objs %}
        interface Vlan{{ vrf.id }}
         description ** SVI for {{ vrf.name }} L3VNI **
         vrf forwarding {{ vrf.name }}
         ip unnumbered {{ DEFN_LOOP_NAME['UNDERLAY'] }}
         no ip redirects
         no ip unreachables
         no ip proxy-arp
         ip pim sparse-mode
         load-interval 30
         carrier-delay msec 0
         no autostate
         hold-queue 4094 in
         hold-queue 4094 out
        {% endfor %}
        
        {# --- INTERFACE NVE1 SECTION --- #}
        interface nve1
         description ** NVE Interface for VXLAN **
         no ip address
         source-interface {{ DEFN_LOOP_NAME['UNDERLAY'] }}
         host-reachability protocol bgp
        {% for vrf in vrf_objs %}
         member vni {{ (L3VNIOFFSET|string) + vrf.id }} vrf {{ vrf.name }}
        {% endfor %}
        {% endraw %}
      template_params:
        - parameter_name: vrf_list
          data_type: STRING
          default_value: null
          description: "List of VRF names to configure"
          required: false
          param_array: true
          selection:
            selection_type: MULTI_SELECT
            selection_values:
              "901": "red"
              "902": "green"
              "903": "blue"
        - parameter_name: L3VNIOFFSET
          data_type: INTEGER
          default_value: 50
          description: "L3 VNI offset for VRF VNIs"
          required: true
          param_array: false
        - parameter_name: __device
          data_type: STRING
          default_value: null
          description: "Device object"
          required: true
          param_array: false
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "Multicast configuration for EVPN fabric"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "4. FABRIC-MCAST"
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% include "EVPN/DEFN-VRF" %}
        {% include "EVPN/DEFN-ROLES" %}
        {% include "EVPN/DEFN-LOOPBACKS" %}
        {% include "EVPN/DEFN-OVERLAY" %}
        {% include "EVPN/DEFN-L3OUT" %}
        {% include "EVPN/DEFN-MCAST" %}
        
        {# Resolve the VRF objects upfront #}
        {% set vrf_objs = [] %}
        {% for input_vrf in vrf_list %}
          {% set _vrf = (DEFN_VRF | selectattr("name", "equalto", input_vrf) | list | first) %}
          {% if _vrf %}{% do vrf_objs.append(_vrf | first) %}{% endif %}
        {% endfor %}
        
        ip multicast-routing
        !
        {% for vrf in vrf_objs %}
        ip multicast-routing vrf {{vrf.name}}
        {% endfor %}
        !
        ip pim spt-threshold 0
        !
        {# CONFIGURE ANYCAST RP INTERFACE ON SPINES ONLY #}
        {% if __device.hostname in DEFN_NODE_ROLES['SPINE'] %}
        interface {{DEFN_LOOP_NAME['ANYCAST']}}
        description AnycastRP Fabric Loopback
        ip address {{FABRIC_RP_ADDR}} 255.255.255.255
        ip pim sparse-mode
        ip {{FABRIC_UNDERLAY.proto}} {{FABRIC_UNDERLAY.instance_id}} area {{FABRIC_UNDERLAY.area}}
        !
        ip msdp cache-sa-state
        {% for spine in DEFN_NODE_ROLES['SPINE'] %}
        {% if spine != __device.hostname %}
        ip msdp peer {{DEFN_LOOP_UNDERLAY[spine]}} connect-source {{DEFN_LOOP_NAME['UNDERLAY']}} remote-as {{FABRIC_BGP_ASN}}
        {% endif %}
        {% endfor %}
        {% endif %}
        !
        
        interface {{DEFN_LOOP_NAME['UNDERLAY']}}
        ip pim sparse-mode
        !
        
        ip access-list standard FABRIC-RP-SCOPE
        {% set acl_index = 10 %}
        {% for scope in FABRIC_RP_SCOPES %}
        {{acl_index}} permit {{scope}}
        {% set acl_index = acl_index + 10 %}
        {% endfor %}
        !
        ip pim rp-address {{FABRIC_RP_ADDR}} FABRIC-RP-SCOPE
        
        ip access-list standard ENTERPRISE-RP-SCOPE
        {% set acl_index = 10 %}
        {% for scope in ENTERPRISE_RP_SCOPES %}
        {{acl_index}} permit {{scope}}
        {% set acl_index = acl_index + 10 %}
        {% endfor %}
        !
        {# -- GRT MAPPING FOR BROWNFIELD VLANS -- #}
        ip pim rp-address {{ENTERPRISE_RP_ADDR}} ENTERPRISE-RP-SCOPE
        
        {% for vrf in vrf_objs %}
        vrf definition {{ vrf.name }}
        address-family ipv4
        mdt auto-discovery vxlan
        mdt default {{ vrf.mdt_default }}
        mdt data {{ vrf.mdt_data }} 0.0.0.255
        exit-address-family
        !
        {% endfor %}
        {% endraw %}
      template_params:
        - parameter_name: vrf_list
          data_type: STRING
          default_value: null
          description: "List of VRF names to configure"
          required: true
          param_array: true
          selection:
            selection_type: MULTI_SELECT
            selection_values:
              "901": "red"
              "902": "blue"
              "903": "green"
        - parameter_name: __device
          data_type: STRING
          default_value: null
          description: "Device object"
          required: true
          param_array: false
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "BGP EVPN control plane configuration"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "5. FABRIC-EVPN"
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% include "EVPN/DEFN-VRF" %}
        {% include "EVPN/DEFN-ROLES" %}
        {% include "EVPN/DEFN-LOOPBACKS" %}
        {% include "EVPN/DEFN-VNIOFFSETS" %}
        {% include "EVPN/DEFN-L3OUT" %}
        {% include "EVPN/DEFN-OVERLAY" %}
        
        {# Resolve input VRF names to full VRF objects #}
        {% set vrf_objs = [] %}
        {% for input_vrf in vrf_list %}
          {% set vrf_match = (DEFN_VRF | selectattr("name", "equalto", input_vrf) | list | first) %}
          {% if vrf_match %}{% do vrf_objs.append(vrf_match | first) %}{% endif %}
        {% endfor %}
        
        {# BGP Border Prefix-List to prevent loops #}
        {% if __device.hostname in DEFN_NODE_ROLES['RR'] %}
        ip as-path access-list 100 permit _$
        !
        route-map EVPN-PEER-BORDER-OUT permit 10 
        match as-path 1
        {% endif %}
        !
        
        {# L3OUT ON SPINES Interface Configuration Block #}
        {% for vrf in vrf_objs %}
        {% for l3out in DEFN_L3OUT %}
        {% if l3out.vrf == vrf.name and l3out.node == __device.hostname %}
        {% for interface, params in l3out.interfaces.items() %}
        interface {{interface}}
         encapsulation dot1Q {{params.vlan}}
         vrf forwarding {{vrf.name}}
         ip address {{params.ipaddr}}
        !
        {% endfor %}
        {% endif %}
        {% endfor %}
        {% endfor %}
        
        router bgp {{FABRIC_BGP_ASN}}
        {# BGP Global Settings Block #}
        {% if __device.hostname in DEFN_NODE_ROLES['RR'] %}
        template peer-policy OVERLAY-LEAF-EVPN-PEER-POLICY
        route-reflector-client
        soft-reconfiguration inbound
        send-community both
        advertise additional-paths all
        exit-peer-policy
        !
        template peer-policy OVERLAY-LEAF-MVPN-PEER-POLICY
        route-reflector-client
        soft-reconfiguration inbound
        send-community both
        exit-peer-policy
        !
        template peer-policy OVERLAY-BORDER-EVPN-PEER-POLICY
        route-map EVPN-PEER-BORDER-OUT out
        soft-reconfiguration inbound
        send-community both
        exit-peer-policy
        {% endif %}
        
        {# BGP Neighbor Configuration #}
        {% if __device.hostname in DEFN_NODE_ROLES['CLIENT'] %}
        {% for rr in DEFN_NODE_ROLES['RR'] %}
        neighbor {{DEFN_LOOP_UNDERLAY[rr]}} remote-as {{FABRIC_BGP_ASN}}
        neighbor {{DEFN_LOOP_UNDERLAY[rr]}} update-source {{DEFN_LOOP_NAME['UNDERLAY']}}
        {% endfor %}
        {% endif %}
        
        {# Address Family L2VPN EVPN #}
        address-family l2vpn evpn
        {% if __device.hostname in DEFN_NODE_ROLES['RR'] %}
        {% for client in DEFN_NODE_ROLES['CLIENT'] %}
        {% if client in DEFN_NODE_ROLES['BORDER'] %}
        neighbor {{DEFN_LOOP_UNDERLAY[client]}} inherit peer-policy OVERLAY-BORDER-EVPN-PEER-POLICY
        {% else %}
        neighbor {{DEFN_LOOP_UNDERLAY[client]}} inherit peer-policy OVERLAY-LEAF-EVPN-PEER-POLICY
        {% endif %}
        neighbor {{DEFN_LOOP_UNDERLAY[client]}} activate
        {% endfor %}
        {% endif %}
        
        {% if __device.hostname in DEFN_NODE_ROLES['CLIENT'] %}
        {% for rr in DEFN_NODE_ROLES['RR'] %}
        neighbor {{DEFN_LOOP_UNDERLAY[rr]}} activate
        neighbor {{DEFN_LOOP_UNDERLAY[rr]}} send-community both
        {% endfor %}
        {% endif %}
        exit-address-family
        {% endraw %}
      template_params:
        - parameter_name: vrf_list
          data_type: STRING
          default_value: null
          description: "List of VRF names to configure"
          required: true
          param_array: true
          selection:
            selection_type: MULTI_SELECT
            selection_values:
              "901": "red"
              "902": "blue"
              "903": "green"
        - parameter_name: __device
          data_type: STRING
          default_value: null
          description: "Device object"
          required: true
          param_array: false
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "VXLAN overlay network services configuration"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "6. FABRIC-OVERLAY"
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% include "EVPN/DEFN-VRF" %}
        {% include "EVPN/DEFN-ROLES" %}
        {% include "EVPN/DEFN-OVERLAY" %}
        {% include "EVPN/DEFN-VNIOFFSETS" %}
        
        {% if FABRIC_BGP_ASN is not none and vrf_list is not none and __device.hostname is not none %}
        
        {# === ROUTER BGP SECTION === #}
        router bgp {{FABRIC_BGP_ASN}}
        {% for vrf in vrf_list %}
          {% for overlay in DEFN_OVERLAY %}
            {% if overlay.vrf == vrf %}
            address-family ipv4 vrf {{vrf}}
            advertise l2vpn evpn
            import path selection all
            redistribute connected
            maximum-paths ibgp {{ DEFN_NODE_ROLES['SPINE'] | length }}
            exit-address-family
            !
            {% endif %}
          {% endfor %}
        {% endfor %}
        
        {# === L2VPN EVPN INSTANCE SECTION === #}
        {% for vrf in vrf_list %}
          {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf %}
            {% if __device.hostname in DEFN_NODE_ROLES['BORDER'] or __device.hostname in DEFN_NODE_ROLES['SPINE']%}
            {# SKIP SPINE AND BORDER L2 DEFN #}
            {% else %}
            {% for vlan, params in overlay.vlans.items() %}
            {% set l2evpn_id = vlan %}
            l2vpn evpn instance {{l2evpn_id}} vlan-based
            encapsulation vxlan
            replication-type static
            !
            {% endfor %}
            {% endif %}
          {% endif %}
          {% endfor %}
        {% endfor %}
        
        {# === VLAN SECTION === #}
        ! @start-ignore-compliance
        {% for vrf in vrf_list %}
          {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf %}
          {% if __device.hostname in DEFN_NODE_ROLES['BORDER'] or __device.hostname in DEFN_NODE_ROLES['SPINE']%}
          {# SKIP SPINE AND BORDER L2 DEFN #}
          {% else %}
          {% for vlan, params in overlay.vlans.items() %}
          vlan {{vlan}}
           name {{params.name}}
          !
          {% endfor %}
          {% endif %}
          {% endif %}
          {% endfor %}
        {% endfor %}
        ! @end-ignore-compliance
        
        {# === VLAN CONFIGURATION SECTION === #}
        {% for vrf in vrf_list %}
          {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf %}
          {% if __device.hostname in DEFN_NODE_ROLES['BORDER'] or __device.hostname in DEFN_NODE_ROLES['SPINE']%}
          {# SKIP SPINE AND BORDER L2 DEFN #}
          {% else %}
          {% for vlan, params in overlay.vlans.items() %}
          vlan configuration {{vlan}}
           member evpn-instance {{vlan}} vni {{L2VNIOFFSET + vlan|int}}
          !
          {% endfor %}
          {% endif %}
          {% endif %}
          {% endfor %}
        {% endfor %}
        
        {# === INTERFACE VLAN SECTION === #}
        {% for vrf in vrf_list %}
          {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf %}
          {% if __device.hostname in DEFN_NODE_ROLES['BORDER'] or __device.hostname in DEFN_NODE_ROLES['SPINE']%}
          {# SKIP SPINE AND BORDER L2 DEFN #}
          {% else %}
          {% for vlan, params in overlay.vlans.items() %}
          interface Vlan{{vlan}}
           description ** SVI for {{params.name}} **
           vrf forwarding {{vrf}}
           ip address {{params.ipaddr}}
           fabric forwarding mode anycast-gateway
           ip helper-address {{params.dhcp_helper}}
           no ip redirects
           no ip unreachables
           no ip proxy-arp
           ip pim sparse-mode
           load-interval 30
           carrier-delay msec 0
          !
          {% endfor %}
          {% endif %}
          {% endif %}
          {% endfor %}
        {% endfor %}
        
        {# === INTERFACE NVE1 L2VNI SECTION === #}
        {% for vrf in vrf_list %}
          {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf %}
          {% if __device.hostname in DEFN_NODE_ROLES['BORDER'] or __device.hostname in DEFN_NODE_ROLES['SPINE']%}
          {# SKIP SPINE AND BORDER L2 DEFN #}
          {% else %}
          interface nve1
          {% for vlan, params in overlay.vlans.items() %}
           member vni {{L2VNIOFFSET + vlan|int}}
            suppress-arp
            mcast-group {{params.bum_addr}}
          {% endfor %}
          {% endif %}
          {% endif %}
          {% endfor %}
        {% endfor %}
        
        {% endif %}
        {% endraw %}
      template_params:
        - parameter_name: vrf_list
          data_type: STRING
          default_value: null
          description: "List of VRF names to configure"
          required: false
          param_array: true
          selection:
            selection_type: MULTI_SELECT
            selection_values:
              "901": "red"
              "902": "blue"
              "903": "green"
        - parameter_name: __device
          data_type: STRING
          default_value: null
          description: "Device object"
          required: true
          param_array: false
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "Network Access Control for IoT segments"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "7. FABRIC-NAC-IOT"
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      template_content: |
        {% raw %}
        {% include "EVPN/DEFN-VRF" %}
        {% include "EVPN/DEFN-NAC-IOT" %}
        
        {% for input_vrf in vrf_list %}
            {% for vrf in DEFN_VRF %}
            {% for nac in DEFN_NAC_IOT %}
                {% if vrf.name == input_vrf and vrf.name == nac.vrf %}
                {% set nac_servername = 'NAC_' + vrf.id + '_' + nac.nac_ip %}
                !
                class-map type control subscriber match-all AAA_SVR_DOWN_AUTHD_HOST
                 match result-type aaa-timeout
                 match authorization-status authorized
                !
                class-map type control subscriber match-all AAA_SVR_DOWN_UNAUTHD_HOST
                 match result-type aaa-timeout
                 match authorization-status unauthorized
                !
                class-map type control subscriber match-all AUTHC_SUCCESS-AUTHZ_FAIL
                 match authorization-status unauthorized
                 match result-type success
                !
                class-map type control subscriber match-all DOT1X_FAILED
                 match method dot1x
                 match result-type method dot1x authoritative
                !
                class-map type control subscriber match-all DOT1X_NO_RESP
                 match method dot1x
                 match result-type method dot1x agent-not-found
                !
                class-map type control subscriber match-all DOT1X_TIMEOUT
                 match method dot1x
                 match result-type method dot1x method-timeout
                !
                class-map type control subscriber match-all MAB_FAILED
                 match method mab
                 match result-type method mab authoritative
                !
                policy-map type control subscriber POLICY_Gi1/0/1
                 event session-started match-all
                  10 class always do-until-failure
                   10 authenticate using dot1x retries 2 retry-time 0 priority 10
                !
                 event authentication-failure match-first
                  10 class DOT1X_FAILED do-until-failure
                   10 terminate dot1x
                   20 authenticate using mab priority 20
                  20 class DOT1X_NO_RESP do-until-failure
                   10 terminate dot1x
                   20 authenticate using mab priority 20
                  30 class DOT1X_TIMEOUT do-until-failure
                   10 terminate dot1x
                   20 authenticate using mab priority 20
                  40 class MAB_FAILED do-until-failure
                   10 terminate mab
                   20 authentication-restart 60
                  50 class AAA_SVR_DOWN_UNAUTHD_HOST do-until-failure
                   10 activate service-template DefaultCriticalAuthVlan_SRV_TEMPLATE
                   20 authorize
                  60 class AAA_SVR_DOWN_AUTHD_HOST do-until-failure
                   10 pause reauthentication
                   20 authorize
                  70 class AUTHC_SUCCESS-AUTHZ_FAIL do-until-failure
                   10 terminate dot1x
                   20 terminate mab
                   30 authentication-restart 60
                !
                 event agent-found match-all
                  10 class always do-until-failure
                   10 terminate mab
                   20 authenticate using dot1x retries 2 retry-time 0 priority 10
                !
                 event inactivity-timeout match-all
                  10 class always do-until-failure
                   10 clear-session
                !
                 event aaa-available match-all
                  10 class IN_CRITICAL_AUTH_CLOSED_MODE do-until-failure
                   10 clear-session
                  20 class NOT_IN_CRITICAL_AUTH_CLOSED_MODE do-until-failure
                   10 resume reauthentication
                !
                 event violation match-all
                  10 class always do-until-failure
                   10 restrict
                !
                radius server {{nac_servername}}
                 address ipv4 {{nac.nac_ip}} auth-port 1812 acct-port 1813
                 key {{nac.nac_key}}
                !
                aaa group server radius {{nac_servername}}
                 server name {{nac_servername}}
                !
                aaa authentication dot1x default group {{nac_servername}}
                aaa authorization network default group {{nac_servername}}
                aaa accounting dot1x default start-stop group {{nac_servername}}
                !
                {% endif %}
            {% endfor %}
            {% endfor %}
        {% endfor %}
        {% endraw %}
      template_params:
        - parameter_name: vrf_list
          data_type: STRING
          default_value: null
          description: "List of VRF names to configure"
          required: false
          param_array: true
          selection:
            selection_type: MULTI_SELECT
            selection_values:
              "901": "red"
              "902": "green"
              "903": "blue"
      version: "1.0"

  # Composite template that combines all FABRIC templates
  - configuration_templates:
      author: admin
      composite: true
      custom_params_order: false
      template_description: "Complete BGP EVPN fabric configuration composite template"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "0. BGP-EVPN"
      project_name: EVPN
      project_description: "BGP EVPN VXLAN Campus Fabric Templates"
      software_type: IOS-XE
      software_version: null
      containing_templates:
        - name: "1. FABRIC-VRF"
          composite: false
          language: JINJA
          description: ""
          project_name: EVPN
        - name: "2. FABRIC-LOOPBACKS"
          composite: false
          language: JINJA
          description: ""
          project_name: EVPN
        - name: "3. FABRIC-NVE"
          composite: false
          language: JINJA
          description: ""
          project_name: EVPN
        - name: "4. FABRIC-MCAST"
          composite: false
          language: JINJA
          description: ""
          project_name: EVPN
        - name: "5. FABRIC-EVPN"
          composite: false
          language: JINJA
          description: ""
          project_name: EVPN
        - name: "6. FABRIC-OVERLAY"
          composite: false
          language: JINJA
          description: ""
          project_name: EVPN
        - name: "7. FABRIC-NAC-IOT"
          composite: false
          language: JINJA
          description: ""
          project_name: EVPN
      version: "1.0"
