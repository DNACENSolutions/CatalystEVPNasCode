# Catalyst Center version
catalyst_center_version: 2.3.7.9

# BGP EVPN Rev2 Project Templates Configuration for Cluster 187
# Site: SJC (San Jose Campus)
# Based on templates from EVPN_Cluster187_site_SJC_cluster_187 folder
# 
# This file contains the data model for deploying BGP EVPN VXLAN Campus Fabric templates
# with IPSec support for multi-cluster deployment to Catalyst Center
# 
# Template Categories:
# 
# Definition Templates (DEFN-*):
#   - DEFN-MCAST: Multicast definitions for EVPN fabric
#   - DEFN-VRF: VRF definitions for multi-tenancy (red, blue, green)
#   - DEFN-ROLES: Device role definitions (spine/leaf/border nodes)
#   - DEFN-LOOPBACKS: Loopback interface definitions for underlay/overlay
#   - DEFN-VNIOFFSETS: VNI offset definitions for L2 and L3 VNIs
#   - DEFN-OVERLAY: Overlay network definitions with VLANs and SVIs
#   - DEFN-L3OUT: Layer 3 external connectivity definitions
#   - DEFN-NAC-IOT: NAC IoT definitions
#   - DEFN-IPSEC: IPSec tunnel definitions for multi-cluster
#   - FUNC-OBJECT-MACROS: Function macros for object resolution
#
# Fabric Templates (FABRIC-*):
#   - 1. FABRIC-VRF: VRF configuration for multi-tenancy
#   - 2. FABRIC-LOOPBACKS: Loopback interface configuration
#   - 3. FABRIC-NVE: Network Virtualization Edge (NVE) interface configuration
#   - 4. FABRIC-MCAST: Multicast configuration for BUM traffic
#   - 5. FABRIC-EVPN: BGP EVPN control plane configuration
#   - 6. FABRIC-OVERLAY: VXLAN overlay network services
#   - 7. FABRIC-IPSEC: IPSec tunnel configuration for multi-cluster
#   - 8. FABRIC-NAC-IOT: Network Access Control for IoT
#
# Composite Template:
#   - 0. BGP-EVPN-BUILD: Complete BGP EVPN fabric configuration (combines all templates)
#
# Usage: Deploy these templates to Catalyst Center using the device_templates role

template_details:
  # ============================================================================
  # DEFINITION TEMPLATES
  # ============================================================================
  
  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Multicast definitions for EVPN fabric - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-MCAST.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      containingTemplates: []
      rollbackTemplateParams: []
      template_content: |
        {% raw %}
        {% set FABRIC_RP_ADDR  = '204.192.3.41' %}
        {% set FABRIC_RP_SCOPES = ['239.190.0.0 0.0.255.255'] %}
        
        {% set ENTERPRISE_RP_ADDR  = '204.192.3.40' %}
        {% set ENTERPRISE_RP_SCOPES = ['238.190.0.0 0.0.255.255'] %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"
      template_variables: []

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "VRF definitions for multi-tenancy - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-VRF.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {# NAMING CONVENTION#}
        {#MDT DEFAULT: 239.190.1XX.1#}
        {#MDT DATA:    239.190. XX.1#}
        {% set DEFN_VRF = [
          {'id':'901','name':'red', 'mdt_default':'239.190.0.1', 'mdt_data':'239.190.1.0'},
          {'id':'902','name':'blue', 'mdt_default':'239.190.0.2', 'mdt_data':'239.190.2.0'},
          {'id':'903','name':'green', 'mdt_default':'239.190.0.3', 'mdt_data':'239.190.3.0'}
          ]
        %}
        
        {# VRF TO NODE MAPPINGS #}
        {# NOT ALL VRF AND VNI NEED TO BE INSTANTIATED ON ALL THE NODES IN FABRIC #}
        {% set DEFN_VRF_TO_NODE = {
          'TB16-Spine.solutionsanity.com':  ['901'],
          'TB16-SJ-Border-3.solutionsanity.com':  ['901'],
          'TB16-SJ-Leaf-1.solutionsanity.com':   ['901','902','903'],
          'TB16-SJ-Leaf-2.solutionsanity.com':   ['901','902','903'],
          'TB16-SJ-Leaf-3.solutionsanity.com':   ['901','902','903'],
          'TB16-SJ-BORDER-1.solutionsanity.com': ['902','903'],
          'TB16-SJ-BORDER-2.solutionsanity.com': ['902','903']
        } %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"
      template_variables: []
      

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Device role definitions for spine/leaf/border nodes - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-ROLES.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {% set DEFN_NODE_ROLES =
          {
          'SPINE':  ['TB16-Spine.solutionsanity.com',
                     'TB16-SJ-Border-3.solutionsanity.com'],
          'RR':     ['TB16-Spine.solutionsanity.com',
                     'TB16-SJ-Border-3.solutionsanity.com'],
          'CLIENT': ['TB16-SJ-Leaf-1.solutionsanity.com',
                     'TB16-SJ-Leaf-2.solutionsanity.com',
                     'TB16-SJ-Leaf-3.solutionsanity.com',
                     'TB16-SJ-BORDER-1.solutionsanity.com',
                     'TB16-SJ-BORDER-2.solutionsanity.com'],
          'BORDER': ['TB16-SJ-BORDER-1.solutionsanity.com',
                     'TB16-SJ-BORDER-2.solutionsanity.com']
          }
        %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"
      template_variables: []

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Loopback interface definitions - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-LOOPBACKS.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {% set DEFN_LOOP_UNDERLAY =
            {
              'TB16-SJ-BORDER-1.solutionsanity.com': '204.1.2.5',
              'TB16-SJ-BORDER-2.solutionsanity.com': '204.1.2.6',
              'TB16-Spine.solutionsanity.com': '204.1.1.4',
              'TB16-SJ-Border-3.solutionsanity.com': '204.1.1.11',
              'TB16-SJ-Leaf-1.solutionsanity.com': '204.1.1.5',
              'TB16-SJ-Leaf-2.solutionsanity.com': '204.1.1.10',
              'TB16-SJ-Leaf-3.solutionsanity.com': '204.1.1.22'
            }
        %}
        
        {% set DEFN_LOOP_IPSEC =
            {
              'TB16-SJ-BORDER-1.solutionsanity.com':  '204.1.2.60',
              'TB16-SJ-BORDER-2.solutionsanity.com':  '204.1.2.70',
              'TB16-NY-Border.solutionsanity.com':     '204.1.2.201'
            }
        %}
        
        {% set DEFN_LOOP_MCLUSTER =
            {
              'TB16-SJ-BORDER-1.solutionsanity.com':  '204.1.2.66',
              'TB16-SJ-BORDER-2.solutionsanity.com':  '204.1.2.77',
              'TB16-NY-Border.solutionsanity.com':     '204.1.2.210'
            }
        %}
        
        {% set DEFN_LOOP_OVERLAY =
            {
              'red':                                    '10.1.91.',
              'blue':                                   '10.1.92.',
              'green':                                  '10.1.93.'
            }
        %}
        
        {% set DEFN_LOOP_NAME =
            {
                'UNDERLAY': 'Loopback0',
                'ANYCAST':  'Loopback2',
                'IPSEC':    'Loopback1',
                'MCLUSTER': 'Loopback2'
            }
        %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"
      template_variables: []

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "VNI offset definitions - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-VNIOFFSETS.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {# NAMING CONVENTIONS   #}
        {# L3VNI {{L3VNIOFFSET}}{{ VRF ID }} #}
        {# L3VNI 50XXX #}
        {# L2VNI {{L2VNIOFFSET}}+{{ VLAN ID }} #}
        {# L2VNI 10XXX #}
        
        {% set L2VNIOFFSET = 10000 %}
        {% set L3VNIOFFSET = 50 %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Overlay network definitions - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-OVERLAY.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {% set FABRIC_BGP_ASN = '65001' %}
        {% set FABRIC_UNDERLAY = {'proto':'ospf', 'instance_id':'1', 'area':'0'} %}
        {% set FABRIC_IPSEC_UNDERLAY = {'proto':'ospf', 'instance_id':'100', 'area':'0'} %}
        
        {% set DEFN_OVERLAY = [
          {
            'vrf': 'red',
            'vlans': {
              '101': {'name':'corp-101', 'ipaddr':'10.1.11.1 255.255.255.0', 'mac':'0000.0901.0101', 'dhcp_helper':'204.192.3.40', 'bum_addr':'239.190.100.101'},
              '201': {'name':'corp-201', 'ipaddr':'10.2.22.1 255.255.255.0', 'mac':'0000.0901.0201', 'dhcp_helper':'204.192.3.40', 'bum_addr':'239.190.100.201'}
            }
          },
          {
            'vrf': 'blue',
            'vlans': {
              '401': {'name':'iot-blue-401', 'ipaddr': '198.18.10.1 255.255.255.0', 'mac':'0000.0902.0401', 'dhcp_helper':'204.192.3.40', 'bum_addr':'239.190.100.41'}
            }
          },
          {
            'vrf': 'green',
            'vlans': {
              '501': {'name':'iot-green-501', 'ipaddr': '198.18.11.1 255.255.255.0', 'mac':'0000.0903.0501', 'dhcp_helper':'204.192.3.40', 'bum_addr':'239.190.100.51'}
            }
          }
        ] %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Layer 3 external connectivity definitions - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-L3OUT.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {% set DEFN_L3OUT = [
          {
            'vrf': 'red',
            'node': 'TB16-Spine.solutionsanity.com',
            'neighbour_asn': '65002',
            'interfaces': {
              'GigabitEthernet1/0/7.2': {'name': 'uplink1', 'vlan': '2', 'ipaddr': '10.255.255.1 255.255.255.252', 'neighbour': '10.255.255.2'},
              'GigabitEthernet1/0/8.2': {'name': 'uplink2', 'vlan': '2', 'ipaddr': '10.255.255.5 255.255.255.252', 'neighbour': '10.255.255.6'}
            }
          },
          {
            'vrf': 'red',
            'node': 'TB16-SJ-Border-3.solutionsanity.com',
            'neighbour_asn': '65002',
            'interfaces': {
              'GigabitEthernet1/0/7.2': {'name': 'uplink1', 'vlan': '2', 'ipaddr': '10.255.255.13 255.255.255.252', 'neighbour': '10.255.255.14'},
              'GigabitEthernet1/0/8.2': {'name': 'uplink2', 'vlan': '2', 'ipaddr': '10.255.255.9 255.255.255.252', 'neighbour': '10.255.255.10'}
            }
          }
        ] %}
        
        {% set DEFN_L3OUT_AGGREGATES = ["10.1.11.0 255.255.255.0",
                                        "10.2.22.0 255.255.255.0"]
        %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "NAC IoT definitions - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-NAC-IOT.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {% set DEFN_NAC_IOT = [
          {'vrf':'blue', 'nac_ip':'198.18.7.254', 'nac_key':'C!sco123'}
          ]
        %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "IPSec tunnel definitions for multi-cluster - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: DEFN-IPSEC.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {% set DEFN_IPSEC =
          {
            'TB16-NY-Border.solutionsanity.com': [
            {
              'tun_ip'      :   '10.100.100.1 255.255.255.252',
              'peer_ip'     :   '10.100.100.2',
              'tun_dst'     :   '172.16.255.60',
              'tun_mode'    :   'gre ip',
              'peer_bgp_asn':   '65001'
            },
            {
              'tun_ip'      :   '10.100.101.1 255.255.255.252',
              'peer_ip'     :   '10.100.101.2',
              'tun_dst'     :   '172.16.255.70',
              'tun_mode'    :   'gre ip',
              'peer_bgp_asn':   '65001'
            }],
            'TB16-SJ-BORDER-1.solutionsanity.com': [
            {
              'tun_ip'      :   '10.100.100.2 255.255.255.252',
              'peer_ip'     :   '10.100.100.1',
              'tun_dst'     :   '172.16.255.201',
              'tun_mode'    :   'gre ip',
              'peer_bgp_asn':   '65003'
            }],
            'TB16-SJ-BORDER-2.solutionsanity.com': [
            {
              'tun_ip'      :   '10.100.101.2 255.255.255.252',
              'peer_ip'     :   '10.100.101.1',
              'tun_dst'     :   '172.16.255.201',
              'tun_mode'    :   'gre ip',
              'peer_bgp_asn':   '65003'
            }]
        } %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: false
      template_description: "Function macros for object resolution - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: FUNC-OBJECT-MACROS.j2
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {# =================================== #}
        {# Resolve the VRF objects upfront     #}
        {# =================================== #}
        {% macro vrf_definition(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME) %}
        {% for input_vrf in DEFN_VRF_TO_NODE[DEVICE_HOSTNAME] %}
          {% set _vrf = (DEFN_VRF | selectattr("id", "equalto", input_vrf) | list | first) %}
          {% if _vrf %}
            {% do vrf_objs.append(_vrf | first) %}
          {% endif %}
        {% endfor %}
        {% endmacro %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  # ============================================================================
  # FABRIC TEMPLATES
  # ============================================================================

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "VRF configuration for multi-tenancy - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "FABRIC-VRF.j2"
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {#BOOTSTRAP FOR SIMULATION#}
        {# Expect these to define DEFN_VRF, vrf_definition(), DEFN_LOOP_UNDERLAY, etc. #}
        {# {% include "EVPN_Cluster187/DEFN-VRF.j2" %} #}
        {# {% include "EVPN_Cluster187/FUNC-OBJECT-MACROS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-LOOPBACKS.j2" %} #}
        
        {# Build VRF CLI for the current device #}
        {% macro vrfDefinitionBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_LOOP_UNDERLAY, FABRIC_BGP_ASN) %}
        {# Resolve the VRF objects upfront #}
        {% set vrf_objs = [] %}
        {{ vrf_definition(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME) }}
        {% for vrf in vrf_objs %}
        vrf definition {{ vrf.name }}
        description VRF {{ vrf.name }} definition
        rd {{ DEFN_LOOP_UNDERLAY[DEVICE_HOSTNAME] }}:{{ vrf.id }}
        !
        address-family ipv4
        route-target export {{ FABRIC_BGP_ASN }}:{{ vrf.id }}
        route-target import {{ FABRIC_BGP_ASN }}:{{ vrf.id }}
        route-target export {{ FABRIC_BGP_ASN }}:{{ vrf.id }} stitching
        route-target import {{ FABRIC_BGP_ASN }}:{{ vrf.id }} stitching
        exit-address-family
        !
        {% endfor %}
        {% endmacro %}
        
        {# Call for current device #}
        {#{% set HOST = __device.hostname | default('', true) %}#}
        {#{{ vrfDefinitionBuild(DEFN_VRF, DEFN_VRF_TO_NODE, HOST, DEFN_LOOP_UNDERLAY, FABRIC_BGP_ASN) }}#}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "Loopback interface configuration - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "FABRIC-LOOPBACKS.j2"
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {#BOOTSTRAP FOR SIMULATION#}
        {# {% include "EVPN_Cluster187/DEFN-VRF.j2" %} #}
        {# {% include "EVPN_Cluster187/FUNC-OBJECT-MACROS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-ROLES.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-LOOPBACKS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-OVERLAY.j2" %} #}
        
        {% macro interfaceLoopbackBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_LOOP_NAME, DEFN_LOOP_UNDERLAY, DEFN_NODE_ROLES, DEFN_LOOP_IPSEC, FABRIC_UNDERLAY, DEFN_LOOP_MCLUSTER) %}
        {# Resolve the VRF objects upfront #}
        {% set vrf_objs = [] %}
        {{ vrf_definition(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME) }}
        
        ! *** FABRIC-LOOPBACKS FOR {{DEVICE_HOSTNAME}}
        {# UNDERLAY LOOPBACKS #}
        interface {{DEFN_LOOP_NAME['UNDERLAY']}}
         description UNDERLAY-NVE-INTERFACE
         ip address {{DEFN_LOOP_UNDERLAY[DEVICE_HOSTNAME]}} 255.255.255.255
         ip pim sparse-mode
        !
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['SPINE']  %}
        {# SKIP SPINE #}
        {% elif DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] %}
        interface {{DEFN_LOOP_NAME['IPSEC']}}
         description IPSEC TUNNEL SOURCE INTERFACE
         ip address {{DEFN_LOOP_IPSEC[DEVICE_HOSTNAME]}} 255.255.255.255
         ip ospf {{FABRIC_UNDERLAY['instance_id']}} area {{FABRIC_UNDERLAY['area']}}
        !
        interface {{DEFN_LOOP_NAME['MCLUSTER']}}
         description NVE MULTICLUSTER INTERFACE
         ip address {{DEFN_LOOP_MCLUSTER[DEVICE_HOSTNAME]}} 255.255.255.255
        !
        {% else %}
        {% for input_vrf in vrf_objs %}
        {% set ip = DEFN_LOOP_UNDERLAY[DEVICE_HOSTNAME] %}
        {% set split_ip = ip.split('\\.') %}
        {% set last_octet = split_ip[3] %}
        interface Loopback{{input_vrf.id}}
         description OVERLAY-VRF-{{input_vrf.name}}
         vrf forwarding {{input_vrf.name}}
         ip address {{DEFN_LOOP_OVERLAY[input_vrf.name]}}{{last_octet}} 255.255.255.255
         ip pim sparse-mode
        !
        {% endfor %}
        {% endif %}
        
        {% endmacro %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "NVE interface configuration - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "FABRIC-NVE.j2"
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {#BOOTSTRAP FOR SIMULATION#}
        {# {% include "EVPN_Cluster187/DEFN-VRF.j2" %} #}
        {# {% include "EVPN_Cluster187/FUNC-OBJECT-MACROS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-ROLES.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-LOOPBACKS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-VNIOFFSETS.j2" %} #}
        
        {% macro nveVlanBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, L3VNIOFFSET, DEFN_LOOP_NAME) %}
        
        {# Resolve the VRF objects upfront #}
        {% set vrf_objs = [] %}
        {{ vrf_definition(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME) }}
        
        {# --- VLAN SECTION --- #}
        ! @start-ignore-compliance {#transparent mode#}
        {% for vrf in vrf_objs %}
        vlan {{ vrf.id }}
         name L3-VRF-CORE-{{ vrf.id }}
        !
        {% endfor %}
        ! @end-ignore-compliance
        
        {# --- VLAN CONFIGURATION SECTION --- #}
        {% for vrf in vrf_objs %}
        vlan configuration {{ vrf.id }}
         member vni {{ (L3VNIOFFSET|string) + vrf.id }}
        !
        {% endfor %}
        
        {# --- INTERFACE VLAN SECTION --- #}
        {% for vrf in vrf_objs %}
        interface Vlan{{ vrf.id }}
         description ** SVI for {{ vrf.name }} L3VNI **
         vrf forwarding {{ vrf.name }}
         ip unnumbered {{ DEFN_LOOP_NAME['UNDERLAY'] }}
         no ip redirects
         no ip unreachables
         no ip proxy-arp
         ip pim sparse-mode
         load-interval 30
         carrier-delay msec 0
         no autostate
         hold-queue 4094 in
         hold-queue 4094 out
        {% endfor %}
        
        {# --- INTERFACE NVE1 SECTION --- #}
        interface nve1
         description ** NVE Interface for VXLAN **
         no ip address
         source-interface {{ DEFN_LOOP_NAME['UNDERLAY'] }}
         host-reachability protocol bgp
        {% for vrf in vrf_objs %}
         member vni {{ (L3VNIOFFSET|string) + vrf.id }} vrf {{ vrf.name }}
        {% endfor %}
            
        {% endmacro %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "Multicast configuration for BUM traffic - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "FABRIC-MCAST.j2"
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {#BOOTSTRAP FOR SIMULATION#}
        {# {% include "EVPN_Cluster187/DEFN-VRF.j2" %} #}
        {# {% include "EVPN_Cluster187/FUNC-OBJECT-MACROS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-ROLES.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-LOOPBACKS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-OVERLAY.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-L3OUT.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-MCAST.j2" %} #}
        
        {% macro multicastRoutingBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_NODE_ROLES, DEFN_LOOP_NAME, DEFN_LOOP_UNDERLAY, FABRIC_RP_ADDR, FABRIC_UNDERLAY, FABRIC_BGP_ASN, FABRIC_RP_SCOPES, ENTERPRISE_RP_SCOPES, ENTERPRISE_RP_ADDR, DEFN_L3OUT ) %}
        
        {# Resolve the VRF objects upfront #}
        {% set vrf_objs = [] %}
        {{ vrf_definition(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME) }}
        
        ip multicast-routing
        !
        {% for vrf in vrf_objs %}
        ip multicast-routing vrf {{vrf.name}}
        {% endfor %}
        !
        ip pim spt-threshold 0
        !
        {# CONFIGURE ANYCAST RP INTERFACE ON SPINES ONLY #}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['SPINE'] %}
        interface {{DEFN_LOOP_NAME['ANYCAST']}}
         description AnycastRP Fabric Loopback
         ip address {{FABRIC_RP_ADDR}} 255.255.255.255
         ip pim sparse-mode
         ip {{FABRIC_UNDERLAY.proto}} {{FABRIC_UNDERLAY.instance_id}} area {{FABRIC_UNDERLAY.area}}
        !
         ip msdp cache-sa-state
        {% for spine in DEFN_NODE_ROLES['SPINE'] %}
        {% if spine != DEVICE_HOSTNAME %}
        ip msdp peer {{DEFN_LOOP_UNDERLAY[spine]}} connect-source {{DEFN_LOOP_NAME['UNDERLAY']}} remote-as {{FABRIC_BGP_ASN}}
        {% endif %}
        {% endfor %}
        {% endif %}
        
        {% endmacro %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "BGP EVPN control plane configuration - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "FABRIC-EVPN.j2"
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {#BOOTSTRAP FOR SIMULATION#}
        {# {% include "EVPN_Cluster187/DEFN-VRF.j2" %} #}
        {# {% include "EVPN_Cluster187/FUNC-OBJECT-MACROS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-ROLES.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-LOOPBACKS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-VNIOFFSETS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-L3OUT.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-OVERLAY.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-IPSEC.j2" %} #}
        
        {% macro evpnBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_NODE_ROLES, DEFN_LOOP_UNDERLAY, DEFN_L3OUT, FABRIC_BGP_ASN, DEFN_LOOP_NAME, DEFN_IPSEC, DEFN_LOOP_MCLUSTER, DEFN_L3OUT_AGGREGATES ) %}
        
        {# Resolve the VRF objects upfront #}
        {% set vrf_objs = [] %}
        {{ vrf_definition(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME) }}
        
        {# =========================================== #}
        {# BGP Border Prefix-List to prevent loops     #}
        {# =========================================== #}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['RR'] %}
        ip as-path access-list 100 permit _$
        !
        route-map EVPN-PEER-BORDER-OUT permit 10 
         match as-path 100
        {% endif %}
        !
        {# ================================================================== #}
        {# FABRICS BGP PEERING MUST TRACK /32 PEER ADDRESSES ONLY             #}
        {# AND NOT FALLBACK TO AGGREGATE/DEFAULT WHEN THE PEER ADDR GOES AWAY #}
        {# ================================================================== #}
        {% for node,loop_ip in DEFN_LOOP_UNDERLAY.items() %}
        ip prefix-list NODE-LOOPBACKS seq {{loop.index}} permit {{loop_ip}}/32
        {% endfor %}
        !
        route-map NODE-LOOPBACKS permit 10
         match ip address prefix-list NODE-LOOPBACKS
        !
        {# ============================================= #}
        {# L3OUT ON SPINES Interface Configuration Block #}
        {# ============================================= #}
        {% for vrf in vrf_objs %}
        {% for l3out in DEFN_L3OUT %}
        {% if l3out.vrf == vrf.name and l3out.node == DEVICE_HOSTNAME %}
        {% for interface, params in l3out.interfaces.items() %}
        interface {{interface}}
         encapsulation dot1Q {{params.vlan}}
         vrf forwarding {{vrf.name}}
         ip address {{params.ipaddr}}
        !
        {% endfor %}
        {% endif %}
        {% endfor %}
        {% endfor %}
        
        router bgp {{FABRIC_BGP_ASN}}
        {# ============================= #}
        {# BGP Global Settings Block     #}
        {# ============================= #}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['RR'] %}
         template peer-policy OVERLAY-LEAF-EVPN-PEER-POLICY
          route-reflector-client
          soft-reconfiguration inbound
          send-community both
          advertise additional-paths all
          exit-peer-policy
        !
         template peer-policy OVERLAY-BORDER-EVPN-PEER-POLICY
          soft-reconfiguration inbound
          send-community both
          exit-peer-policy
        !
         template peer-policy OVERLAY-LEAF-MVPN-PEER-POLICY
          route-reflector-client
          soft-reconfiguration inbound
          send-community both
          exit-peer-policy
        !
         template peer-policy OVERLAY-BORDER-EVPN-PEER-POLICY
          route-map EVPN-PEER-BORDER-OUT out
          route-reflector-client
          soft-reconfiguration inbound
          send-community both
          exit-peer-policy
        !
         template peer-session UNDERLAY-LEAF-EVPN-PEER-SESSION-POLICY
          remote-as {{FABRIC_BGP_ASN}}
          log-neighbor-changes
          update-source {{DEFN_LOOP_NAME['UNDERLAY']}}
          fall-over route-map NODE-LOOPBACKS
          exit-peer-session
        !
        {% endif %}
        
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['CLIENT'] %}
         template peer-policy OVERLAY-SPINE-EVPN-PEER-POLICY
          soft-reconfiguration inbound
          send-community both
          exit-peer-policy
        !
         template peer-session UNDERLAY-SPINE-EVPN-PEER-SESSION-POLICY
          remote-as {{FABRIC_BGP_ASN}}
          description SPINE-EVPN-PEER
          log-neighbor-changes
          update-source {{DEFN_LOOP_NAME['UNDERLAY']}}
          fall-over route-map NODE-LOOPBACKS
          exit-peer-session
        !
        {% endif %}
        
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] %}
        template peer-session OVERLAY-Border-EVPN-PEER-SESSION-POLICY
          description VXLAN-GW-2-LEAF-EVPN-PEER
          log-neighbor-changes
          ebgp-multihop 255
          update-source Loopback2
         exit-peer-session
        {% endif %}
        
         bgp router-id interface Loopback0
         bgp log-neighbor-changes
         {# bgp graceful-restart #}
         no bgp default ipv4-unicast
        !
        {# ============================= #}
        {# BGP Neighbors                #}
        {# ============================= #}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['RR'] %}
        {% for client in DEFN_NODE_ROLES['CLIENT'] %}
          neighbor {{DEFN_LOOP_UNDERLAY[client]}} inherit peer-session UNDERLAY-LEAF-EVPN-PEER-SESSION-POLICY
        {% endfor %}
        {% endif %}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['CLIENT'] %}
        {% for rr in DEFN_NODE_ROLES['RR'] %}
          neighbor {{DEFN_LOOP_UNDERLAY[rr]}} inherit peer-session UNDERLAY-SPINE-EVPN-PEER-SESSION-POLICY
        {% endfor %}
        {% endif %}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] %}
        {# BUILD MULTI-CLUSTER NEIGHBORS #}
        {% for tun,params in DEFN_IPSEC.items() %}
        {% if tun == DEVICE_HOSTNAME %}
        {% for p in params %}
          neighbor {{p['peer_ip']}} inherit peer-session OVERLAY-BORDER-EVPN-PEER-SESSION-POLICY
          neighbor {{p['peer_ip']}} remote-as {{p['peer_bgp_asn']}}
          neighbor {{p['peer_ip']}} activate
        {% endfor %}
        {% endif %}
        {% endfor %}
        {% endif %}
        !
        {# ============================= #}
        {# Address-Family: ipv4          #}
        {# ============================= #}
          address-family ipv4
           maximum-paths ibgp {{ DEFN_NODE_ROLES['BORDER'] | length }}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] %}
           network {{DEFN_LOOP_MCLUSTER[DEVICE_HOSTNAME]}} mask 255.255.255.255
        {% endif %}
           exit-address-family
        !
        {# ============================= #}
        {# Address-Family: ipv4 vrf      #}
        {# L3OUT CONFIGURATION ON SPINES #}
        {# ============================= #}
        {% for vrf in vrf_objs %}
        {% for l3out in DEFN_L3OUT %}
        {% if l3out.vrf == vrf.name and l3out.node == DEVICE_HOSTNAME and DEVICE_HOSTNAME in DEFN_NODE_ROLES['SPINE'] %}
          address-family ipv4 vrf {{vrf.name}}
           advertise l2vpn evpn
        
        {% for aggregate in DEFN_L3OUT_AGGREGATES %}
           aggregate-address {{aggregate}} summary-only
        {% endfor %}
           redistribute static
           redistribute connected
        {% for interface, params in l3out.interfaces.items() %}
           neighbor {{params.neighbour}} remote-as {{l3out.neighbour_asn}}
           neighbor {{params.neighbour}} activate
        {% endfor %}
           exit-address-family
        !
        {% endif %}
        {% endfor %}
        {% endfor %}
        !
        {# ============================= #}
        {# Address-Family: ipv4 vrf      #}
        {# L3OUT CONFIGURATION ON BORDERS #}
        {# ============================= #}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] %}
        {% for vrf in vrf_objs %}
          address-family ipv4 vrf {{vrf.name}}
           advertise l2vpn evpn
           import path selection all
           maximum-paths ibgp {{ DEFN_NODE_ROLES['SPINE'] | length }}
           exit-address-family
        !
        {% endfor %}
        {% endif %}
        {# ============================= #}
        {# Address-Family: l2vpn evpn    #}
        {# ============================= #}
          address-family l2vpn evpn
           bgp nexthop trigger delay 0
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['RR'] %}
           bgp additional-paths select all
           bgp additional-paths send receive
        {% for client in DEFN_NODE_ROLES['CLIENT'] %}
        {# BORDER PEER POLICY APPLIES AS-PATH PREFIX OUT TO PREVENT SPINES FROM          #}
        {# REFLECTING ROUTES RECEIVED FROM THE BORDER BACK AT THE BORDER CREATING A LOOP #}
        {# THIS IS REQUIRED WHEN SPINES ARE CONFIGURED WITH THESE TWO COMMANDS           #}
        {# bgp additional-paths select all                                               #}
        {# bgp additional-paths send receive                                             #}
        {% if client in DEFN_NODE_ROLES['BORDER'] %}
           neighbor {{DEFN_LOOP_UNDERLAY[client]}} activate
           neighbor {{DEFN_LOOP_UNDERLAY[client]}} inherit peer-policy OVERLAY-BORDER-EVPN-PEER-POLICY
        {% else %}
           neighbor {{DEFN_LOOP_UNDERLAY[client]}} activate
           neighbor {{DEFN_LOOP_UNDERLAY[client]}} inherit peer-policy OVERLAY-LEAF-EVPN-PEER-POLICY
        {% endif %}
        {% endfor %}
        {% endif %}
        
        {# BORDER NODES ARE SUBSET OF CLIENTS, BUT THEY HAVE ADDITIONAL LOGIC            #}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['CLIENT'] %}
        
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] %}
        {# VXLAN MULTI-CLUSTER SUPPORT #}
           rewrite-evpn-rt-asn
        {# BUILD MULTI-CLUSTER NEIGHBORS #}
        {% for tun,params in DEFN_IPSEC.items() %}
        {% if tun == DEVICE_HOSTNAME %}
        {% for p in params %}
           neighbor {{p['peer_ip']}} inherit peer-session OVERLAY-BORDER-EVPN-PEER-SESSION-POLICY
           neighbor {{p['peer_ip']}} remote-as {{p['peer_bgp_asn']}}
           neighbor {{p['peer_ip']}} activate
        {% endfor %}
        {% endif %}
        {% endfor %}
        
        {% else %}
           bgp additional-paths receive
        {% endif %}
        
        {% for rr in DEFN_NODE_ROLES['RR'] %}
           neighbor {{DEFN_LOOP_UNDERLAY[rr]}} activate
           neighbor {{DEFN_LOOP_UNDERLAY[rr]}} inherit peer-policy OVERLAY-SPINE-EVPN-PEER-POLICY
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] %}
           neighbor {{DEFN_LOOP_UNDERLAY[rr]}} next-hop-self
        {% endif %}
        {% endfor %}
        {% endif %}
           exit-address-family
        !
        
        
        {# ============================= #}
        {# Address-Family: ipv4 mvpn   #}
        {# ============================= #}
          address-family ipv4 mvpn
           bgp nexthop trigger delay 0
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['RR'] %}
        {% for client in DEFN_NODE_ROLES['CLIENT'] %}
           neighbor {{DEFN_LOOP_UNDERLAY[client]}} activate
           neighbor {{DEFN_LOOP_UNDERLAY[client]}} inherit peer-policy OVERLAY-LEAF-MVPN-PEER-POLICY
        {% endfor %}
        {% endif %}
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['CLIENT'] %}
        {% for rr in DEFN_NODE_ROLES['RR'] %}
           neighbor {{DEFN_LOOP_UNDERLAY[rr]}} activate
           neighbor {{DEFN_LOOP_UNDERLAY[rr]}} inherit peer-policy OVERLAY-SPINE-EVPN-PEER-POLICY
        {% endfor %}
        {% endif %}
           exit-address-family
        !
            
        {% endmacro %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "VXLAN overlay network services - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "FABRIC-OVERLAY.j2"
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {#BOOTSTRAP FOR SIMULATION#}
        {#{% include "EVPN_Cluster187/DEFN-VRF.j2" %}#}
        {#{% include "EVPN_Cluster187/DEFN-ROLES.j2" %}#}
        {#{% include "EVPN_Cluster187/DEFN-OVERLAY.j2" %}#}
        {#{% include "EVPN_Cluster187/DEFN-VNIOFFSETS.j2" %}#}
        {#{% include "EVPN_Cluster187/FUNC-OBJECT-MACROS.j2" %}#}
        
        {% macro overlayBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, FABRIC_BGP_ASN, DEFN_OVERLAY, DEFN_NODE_ROLES, L2VNIOFFSET) %}
        
        {# Resolve the VRF objects upfront #}
        {% set vrf_objs = [] %}
        {{ vrf_definition(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME) }}
        
        {% if FABRIC_BGP_ASN is not none and vrf_objs is not none and DEVICE_HOSTNAME is not none %}
        
        {# === ROUTER BGP SECTION === #}
        router bgp {{FABRIC_BGP_ASN}}
        {% for vrf in vrf_objs %}
          {% for overlay in DEFN_OVERLAY %}
            {% if overlay.vrf == vrf.name %}
         address-family ipv4 vrf {{vrf.name}}
         advertise l2vpn evpn
         import path selection all
         redistribute connected
         maximum-paths ibgp {{ DEFN_NODE_ROLES['SPINE'] | length }}
         exit-address-family
         !
            {% endif %}
          {% endfor %}
        {% endfor %}
        
        {# === L2VPN EVPN INSTANCE SECTION === #}
        {% for vrf in vrf_objs %}
          {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf.name %}
            {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] or DEVICE_HOSTNAME in DEFN_NODE_ROLES['SPINE']%}
            {# SKIP SPINE AND BORDER L2 DEFN #}
            {# AS NOT IN LOGIC IS NOT SUPPORTED IN THIS J2 ENGINE #}
            {% else %}
            {% for vlan, params in overlay.vlans.items() %}
            {% set l2evpn_id = vlan %}
        l2vpn evpn instance {{l2evpn_id}} vlan-based
         encapsulation vxlan
         replication-type static
            !
            {% endfor %}
            {% endif %}
          {% endif %}
          {% endfor %}
        {% endfor %}
        
        {# === VLAN SECTION === #}
        ! @start-ignore-compliance
        {% for vrf in vrf_objs %}
          {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf.name %}
          {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] or DEVICE_HOSTNAME in DEFN_NODE_ROLES['SPINE']%}
          {# SKIP SPINE AND BORDER L2 DEFN #}
          {# AS NOT IN LOGIC IS NOT SUPPORTED IN THIS J2 ENGINE #}
          {% else %}
            {% for vlan, params in overlay.vlans.items() %}
        vlan {{ vlan }}
         name DAG-{{params.name}}
        !
            {% endfor %}
          {% endif %}
          {% endif %}
          {% endfor %}
        {% endfor %}
        ! @end-ignore-compliance
        
        {# === VLAN CONFIGURATION SECTION === #}
        {% for vrf in vrf_objs %}
          {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf.name %}
          {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] or DEVICE_HOSTNAME in DEFN_NODE_ROLES['SPINE']%}
          {# SKIP SPINE AND BORDER L2 DEFN #}
          {# AS NOT IN LOGIC IS NOT SUPPORTED IN THIS J2 ENGINE #}
          {% else %}
          {% for vlan, params in overlay.vlans.items() %}
          {% set l2evpn_id = vlan %}
          {% set l2vni_id = (L2VNIOFFSET | int) + (vlan | int) %}
        vlan configuration {{ vlan }}
         member evpn-instance {{ l2evpn_id }} vni {{ l2vni_id }}
        !
          {% endfor %}
          {% endif %}
          {% endif %}
          {% endfor %}
        {% endfor %}
        
        {# === INTERFACE NVE1 SECTION === #}
        interface nve1
        {% for vrf in vrf_objs %}
          {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf.name %}
          {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] or DEVICE_HOSTNAME in DEFN_NODE_ROLES['SPINE']%}
          {# SKIP SPINE AND BORDER L2 DEFN #}
          {# AS NOT IN LOGIC IS NOT SUPPORTED IN THIS J2 ENGINE #}
          {% else %}
          {% for vlan, params in overlay.vlans.items() %}
          {% set l2vni_id = (L2VNIOFFSET | int) + (vlan | int) %}
         member vni {{l2vni_id}} mcast-group {{params.bum_addr}}
          {% endfor %}
          {% endif %}
          {% endif %}
          {% endfor %}
        {% endfor %}
        
        
        {# === INTERFACE VLANX SECTION === #}
        {% for vrf in vrf_objs %}
        {% for overlay in DEFN_OVERLAY %}
          {% if overlay.vrf == vrf.name %}
          
          {% set vrf_obj = DEFN_VRF | selectattr('name', 'equalto', vrf.name) | list | first %}
          {% set dhcp_source_interface = 'Loopback' + vrf_obj.id %}
        
          {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER'] or DEVICE_HOSTNAME in DEFN_NODE_ROLES['SPINE']%}
          {# SKIP SPINE AND BORDER L2 DEFN #}
          {# AS NOT IN LOGIC IS NOT SUPPORTED IN THIS J2 ENGINE #}
          {% else %}
          {% for vlan, params in overlay.vlans.items() %}
        interface Vlan{{ vlan }}
         description DAG-{{ params.name }}
         vrf forwarding {{ overlay.vrf }}
         mac-address {{ params.mac }}
         ip address {{ params.ipaddr }}
         ip dhcp relay source-interface {{ dhcp_source_interface }}
         ip helper-address {{ params.dhcp_helper }}
         ip pim sparse-mode
        !
          {% endfor %}
          {% endif %}
          
          {% endif %}
        {% endfor %}
        {% endfor %}
        
        {% endif %}
            
        {% endmacro %}
        
        {#BOOTSTRAP FOR SIMULATION#}
        {#UNCOMMENT CORRESPONDING INCLUDE STATEMENTS IN TOP SECTION#}
        {#{% set DEVICE_HOSTNAME = __device.hostname | default('', true) %}#}
        {#{{ overlayBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, FABRIC_BGP_ASN, DEFN_OVERLAY, DEFN_NODE_ROLES, L2VNIOFFSET) }}#}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "IPSec tunnel configuration for multi-cluster - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "FABRIC-IPSEC.j2"
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {#BOOTSTRAP FOR SIMULATION#}
        {# {% include "EVPN_Cluster187/DEFN-ROLES.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-LOOPBACKS.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-OVERLAY.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-IPSEC.j2" %} #}
        
        {% macro interfaceTunnelBuild(DEFN_NODE_ROLES, FABRIC_IPSEC_UNDERLAY, DEFN_LOOP_IPSEC, DEFN_LOOP_NAME) %}
        
        {% if DEVICE_HOSTNAME in DEFN_NODE_ROLES['BORDER']  %}
        router ospf {{FABRIC_IPSEC_UNDERLAY['instance_id']}}
         router-id {{DEFN_LOOP_IPSEC[DEVICE_HOSTNAME]}}
        !
        {% set tun_index = (DEFN_LOOP_IPSEC[DEVICE_HOSTNAME]).split('\\.')[3] | int %}
        {% set tun_list = DEFN_IPSEC[DEVICE_HOSTNAME] %}
        {% for tun in tun_list %}
        interface Tunnel{{tun_index + loop.index0}}
         description TUNNEL TO DMZ HUB
         ip address {{tun['tun_ip']}}
         ip ospf {{FABRIC_IPSEC_UNDERLAY['instance_id']}} area {{FABRIC_IPSEC_UNDERLAY['area']}}
         carrier-delay msec 0
         tunnel source {{DEFN_LOOP_NAME['IPSEC']}}
         tunnel mode {{tun['tun_mode']}}
         tunnel destination {{tun['tun_dst']}}
        {% endfor %}
        {% endif %}
            
        {% endmacro %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "Network Access Control for IoT segments - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "FABRIC-NAC-IOT.j2"
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_content: |
        {% raw %}
        {#BOOTSTRAP FOR SIMULATION#}
        {# {% include "EVPN_Cluster187/DEFN-VRF.j2" %} #}
        {# {% include "EVPN_Cluster187/DEFN-NAC-IOT.j2" %} #}
        
        {% macro ibnsBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_NAC_IOT) %}
        
        {% for input_vrf in vrf_list %}
            {% for vrf in DEFN_VRF %}
            {% for nac in DEFN_NAC_IOT %}
                {% if vrf.name == input_vrf and vrf.name == nac.vrf %}
                {% set nac_servername = 'NAC_' + vrf.id + '_' + nac.nac_ip %}
        !
        #INTERACTIVE
        class-map type control subscriber match-all AAA_SVR_DOWN_AUTHD_HOST<IQ>Do you wish to continue?<R>yes
        #END_INTERACTIVE
         match result-type aaa-timeout
         match authorization-status authorized
        !
        class-map type control subscriber match-all AAA_SVR_DOWN_UNAUTHD_HOST
         match result-type aaa-timeout
         match authorization-status unauthorized
        !
        class-map type control subscriber match-all AUTHC_SUCCESS-AUTHZ_FAIL
         match authorization-status unauthorized
         match result-type success
        !
        class-map type control subscriber match-all DOT1X_FAILED
         match method dot1x
         match result-type method dot1x authoritative
        !
        class-map type control subscriber match-all DOT1X_NO_RESP
         match method dot1x
         match result-type method dot1x agent-not-found
        !
        class-map type control subscriber match-all DOT1X_TIMEOUT
         match method dot1x
         match result-type method dot1x method-timeout
        !
        class-map type control subscriber match-all IN_CRITICAL_AUTH_CLOSED_MODE
         match activated-service-template DefaultCriticalAuthVlan_SRV_TEMPLATE
         match activated-service-template DefaultCriticalVoice_SRV_TEMPLATE
        !
        class-map type control subscriber match-all MAB_FAILED
         match method mab
         match result-type method mab authoritative
        !
        class-map type control subscriber match-none NOT_IN_CRITICAL_AUTH_CLOSED_MODE
         match activated-service-template DefaultCriticalAuthVlan_SRV_TEMPLATE
         match activated-service-template DefaultCriticalVoice_SRV_TEMPLATE
        !
        radius server {{nac_servername}}
         address ipv4 {{nac.nac_ip}} auth-port 1812 acct-port 1813
         key {{nac.nac_key}}
        !
        aaa group server radius NAC_IOT_{{vrf.id}}
        server name {{nac_servername}}
        ip vrf forwarding {{vrf.name}}
        ip radius source-interface Loopback{{vrf.id}}
        retransmit 2
        timeout 10
        !
        aaa authentication dot1x NAC_IOT_AUTH_{{vrf.id}} group NAC_IOT_{{vrf.id}}
        aaa authorization network NAC_IOT_AUTHZ_{{vrf.id}} group NAC_IOT_{{vrf.id}}
        !
        policy-map type control subscriber NAC_IOT_PM_{{vrf.id}}
         event session-started match-all
          10 class always do-until-failure
           10 authenticate using mab aaa authc-list NAC_IOT_AUTH_{{vrf.id}} authz-list NAC_IOT_AUTHZ_{{vrf.id}} priority 10
         event authentication-failure match-first
          5 class DOT1X_FAILED do-until-failure
           10 terminate dot1x
           20 authenticate using mab priority 20
          10 class AAA_SVR_DOWN_UNAUTHD_HOST do-until-failure
           10 activate service-template DefaultCriticalAuthVlan_SRV_TEMPLATE
           20 activate service-template DefaultCriticalVoice_SRV_TEMPLATE
           30 authorize
           40 pause reauthentication
          20 class AAA_SVR_DOWN_AUTHD_HOST do-until-failure
           10 pause reauthentication
           20 authorize
          30 class DOT1X_NO_RESP do-until-failure
           10 terminate dot1x
           20 authenticate using mab priority 20
          40 class MAB_FAILED do-until-failure
           10 terminate mab
           20 authentication-restart 60
          50 class DOT1X_TIMEOUT do-until-failure
           10 terminate dot1x
           20 authenticate using mab priority 20
          60 class always do-until-failure
           10 terminate dot1x
           20 terminate mab
           30 authentication-restart 60
         event aaa-available match-all
          10 class IN_CRITICAL_AUTH_CLOSED_MODE do-until-failure
           10 clear-session
          20 class NOT_IN_CRITICAL_AUTH_CLOSED_MODE do-until-failure
           10 resume reauthentication
         event agent-found match-all
          10 class always do-until-failure
           10 terminate mab
           20 authenticate using dot1x retries 2 retry-time 0 priority 10
         event inactivity-timeout match-all
          10 class always do-until-failure
           10 clear-session
         event authentication-success match-all
         event violation match-all
          10 class always do-until-failure
           10 restrict
         event authorization-failure match-all
          10 class AUTHC_SUCCESS-AUTHZ_FAIL do-until-failure
           10 authentication-restart 60
        !
        template NAC_TEMPLATE_IOT_{{vrf.id}}
        dot1x pae authenticator
        dot1x timeout tx-period 7
        dot1x timeout supp-timeout 7
        dot1x max-req 3
        dot1x max-reauth-req 3
        mab
        access-session closed
        access-session port-control auto
        authentication periodic
        authentication timer reauthenticate server
        service-policy type control subscriber NAC_IOT_PM_{{vrf.id}}
        load-interval 30
                {% endif %}
            {% endfor %}
            {% endfor %}
        {% endfor %}
            
        {% endmacro %}
        
        {# End of File #}
        {% endraw %}
      version: "1.0"

  # ============================================================================
  # COMPOSITE TEMPLATE
  # ============================================================================

  - configuration_templates:
      author: admin
      composite: false
      custom_params_order: true
      template_description: "Complete BGP EVPN VXLAN Campus Fabric with IPSec - Cluster 187"
      device_types:
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9500 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9000 Series Virtual Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9300 Series Switches
        - product_family: Switches and Hubs
          product_series: Cisco Catalyst 9400 Series Switches
      failure_policy: ABORT_TARGET_ON_ERROR
      language: JINJA
      template_name: "BGP-EVPN-BUILD.j2"
      project_name: EVPN_Cluster187
      project_description: "BGP EVPN VXLAN Campus Fabric Templates with IPSec - Cluster 187 SJC"
      software_type: IOS
      softwareVariant: XE
      software_version: null
      template_variables: []
      template_content: |
        {% raw %}
        {% include "EVPN_Cluster187/DEFN-VRF.j2" %}
        {% include "EVPN_Cluster187/DEFN-ROLES.j2" %}
        {% include "EVPN_Cluster187/DEFN-LOOPBACKS.j2" %}
        {% include "EVPN_Cluster187/DEFN-OVERLAY.j2" %}
        {% include "EVPN_Cluster187/DEFN-IPSEC.j2" %}
        {% include "EVPN_Cluster187/DEFN-VNIOFFSETS.j2" %}
        {% include "EVPN_Cluster187/DEFN-L3OUT.j2" %}
        {% include "EVPN_Cluster187/DEFN-MCAST.j2" %}
        {% include "EVPN_Cluster187/DEFN-NAC-IOT.j2" %}
        {% include "EVPN_Cluster187/FUNC-OBJECT-MACROS.j2" %}
        {% include "EVPN_Cluster187/FABRIC-VRF.j2" %}
        {% include "EVPN_Cluster187/FABRIC-LOOPBACKS.j2" %}
        {% include "EVPN_Cluster187/FABRIC-IPSEC.j2" %}
        {% include "EVPN_Cluster187/FABRIC-NVE.j2" %}
        {% include "EVPN_Cluster187/FABRIC-MCAST.j2" %}
        {% include "EVPN_Cluster187/FABRIC-EVPN.j2" %}
        {% include "EVPN_Cluster187/FABRIC-OVERLAY.j2" %}
        {% include "EVPN_Cluster187/FABRIC-NAC-IOT.j2" %}
        
        {# DEREFERENCE THE DEVICE HOSTNAME ONCE AND PASS TO EACH BUILD FUNCTION #}
        {% set DEVICE_HOSTNAME = __device.hostname | default('', true) %}
        
        {# BUILD LAYERS OF CONFIG #}
        {# Step 1. VRF #}
        {{ vrfDefinitionBuild(DEF_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_LOOP_UNDERLAY, FABRIC_BGP_ASN) }}
        
        {# Step 2. UNDERLAY AND SERVICE LOOPBACKS #}
        {{ interfaceLoopbackBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_LOOP_NAME, DEFN_LOOP_UNDERLAY, DEFN_NODE_ROLES, DEFN_LOOP_IPSEC, FABRIC_UNDERLAY, DEFN_LOOP_MCLUSTER) }}
        
        {# Step 3. UNDERLAY IPSEC OR GRE TRANSPORT TUNNELS ONLY ON BORDERS #}
        {{ interfaceTunnelBuild(DEFN_NODE_ROLES, FABRIC_IPSEC_UNDERLAY, DEFN_LOOP_IPSEC, DEFN_LOOP_NAME) }}
        
        {# Step 4. VLANS, L2VNI AND L3VNI MAPPINGS #}
        {{ nveVlanBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, L3VNIOFFSET, DEFN_LOOP_NAME) }}
        
        {# Step 5. MULTICAST - TRM #}
        {{ multicastRoutingBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_NODE_ROLES, DEFN_LOOP_NAME, DEFN_LOOP_UNDERLAY, FABRIC_RP_ADDR, FABRIC_UNDERLAY, FABRIC_BGP_ASN, FABRIC_RP_SCOPES, ENTERPRISE_RP_SCOPES, ENTERPRISE_RP_ADDR, DEFN_L3OUT ) }}
        
        {# Step 6. BGP EVPN PEERINGS #}
        {{ evpnBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_NODE_ROLES, DEFN_LOOP_UNDERLAY, DEFN_L3OUT, FABRIC_BGP_ASN, DEFN_LOOP_NAME, DEFN_IPSEC, DEFN_LOOP_MCLUSTER, DEFN_L3OUT_AGGREGATES ) }}
        
        {# Step 7. BGP OVERLAYS #}
        {{ overlayBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, FABRIC_BGP_ASN, DEFN_OVERLAY, DEFN_NODE_ROLES, L2VNIOFFSET) }}
        
        {# Step 8. SECURE ACCESS PORTS #}
        {{ ibnsBuild(DEFN_VRF, DEFN_VRF_TO_NODE, DEVICE_HOSTNAME, DEFN_NAC_IOT) }}
        
        {# End of Build #}
        {% endraw %}
      version: "1.0"
